// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema     

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init
   
generator client {
  provider = "prisma-client-js"                                                                      
}                                                       
                      
datasource db {                              
  provider = "postgresql"              
}                 
                
enum Role {         
  SUPER_ADMIN                  
  ADMIN              
  USER                       
}    
   
model User {
  id                  Int               @id @default(autoincrement())
  uuid                String            @unique @default(uuid())
  nom                 String    
  prenom              String                     
  email               String            @unique   
  photo               String? // ðŸ‘ˆ NextAuth (image / photo)
  role                Role?                
  telephone           String?                    
  adresse             String?            
  passwordHash        String?
  etat                MemberStatus      @default(ACTIF)            
  dateAdhesion        DateTime          @default(now())      

  wallet              Wallet?
  gestionnaire        Gestionnaire?          
  tontines            TontineMembre[]
  credits             Credit[]
  creditsAlim         CreditAlimentaire[]
  cotisations         Cotisation[]
  factures            Facture[] // âœ… AJOUTÃ‰
  auditLogs           AuditLog[] // âœ… (pour erreur suivante)
  notifications       Notification[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

enum MemberStatus {
  ACTIF
  INACTIF
  SUSPENDU
}

model Client {
  id                  Int               @id @default(autoincrement())
  nom                 String
  prenom              String
  telephone           String            @unique
  adresse             String?
  etat                MemberStatus      @default(ACTIF)

  credits             Credit[]
  creditsAlim         CreditAlimentaire[]
  cotisations         Cotisation[]
  tontines            TontineMembre[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model Wallet {
  id                  Int               @id @default(autoincrement())
  memberId            Int               @unique
  soldeGeneral        Decimal           @default(0.0)
  soldeTontine        Decimal           @default(0.0)
  soldeCredit         Decimal           @default(0.0)

  member              User              @relation(fields: [memberId], references: [id])
  transactions        WalletTransaction[]
  paiements           Paiement[] // âœ… AJOUTÃ‰ pour relation inverse

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model WalletTransaction {
  id                  Int               @id @default(autoincrement())
  walletId            Int
  type                TransactionType
  montant             Decimal
  description         String?
  reference           String            @unique

  wallet              Wallet            @relation(fields: [walletId], references: [id])

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

enum TransactionType {         
  DEPOT
  RETRAIT
  COTISATION  
  TONTINE
  REMBOURSEMENT_CREDIT
  CREDIT
  ACHAT
  ANNULATION
}

model Gestionnaire {
  id                  Int               @id @default(autoincrement())
  memberId            Int               @unique
  role                RoleGestionnaire
  actif               Boolean           @default(true)

  member              User              @relation(fields: [memberId], references: [id])

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

enum RoleGestionnaire {
  SUPER_ADMIN
  ADMIN
  RESPONSABLE_POINT_DE_VENTE
  RESPONSABLE_COMMUNAUTE
  REVENDEUR
  AGENT_LOGISTIQUE_APPROVISIONNEMENT
  MAGAZINIER
  CAISSIER
  COMMERCIAL
  COMPTABLE  
  AUDITEUR_INTERNE
  RESPONSABLE_VENTE_CREDIT
  CONTROLEUR_TERRAIN
  AGENT_TERRAIN
  RESPONSABLE_ECONOMIQUE
  RESPONSABLE_MARKETING
  ACTIONNAIRE
}
  
model Cotisation {
  id                  Int               @id @default(autoincrement())
  memberId            Int?
  member              User?             @relation(fields: [memberId], references: [id])

  clientId            Int?
  client              Client?           @relation(fields: [clientId], references: [id])

  montant             Decimal
  periode             PeriodeCotisation
  datePaiement        DateTime?
  dateExpiration      DateTime

  statut              StatutCotisation  @default(EN_ATTENTE)

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

enum PeriodeCotisation {   
  MENSUEL
  ANNUEL
}

enum StatutCotisation {
  EN_ATTENTE
  PAYEE
  EXPIREE              
}
 
model Tontine {
  id                  Int               @id @default(autoincrement())
  nom                 String
  description         String?
  montantCycle        Decimal
  frequence           Frequence
  statut              StatutTontine     @default(ACTIVE)
  dateDebut           DateTime
  dateFin             DateTime?

  membres             TontineMembre[]
  cycles              TontineCycle[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model TontineMembre {
  id                  Int               @id @default(autoincrement())
  tontineId           Int
  memberId            Int?
  ordreTirage         Int?
  dateEntree          DateTime          @default(now())
  dateSortie          DateTime?

  clientId            Int?
  client              Client?           @relation(fields: [clientId], references: [id])

  tontine             Tontine           @relation(fields: [tontineId], references: [id])
  member              User?             @relation(fields: [memberId], references: [id])
  contributions       TontineContribution[]
  cyclesBeneficiaire  TontineCycle[]    @relation("CycleBeneficiaire")

  @@unique([tontineId, clientId])
}

enum Frequence {
  HEBDOMADAIRE
  MENSUEL
}

enum StatutTontine {
  ACTIVE
  TERMINEE
  SUSPENDUE
}

enum StatutCycle {
  EN_COURS
  COMPLETE
  ANNULE
}

enum StatutContribution {
  EN_ATTENTE
  PAYEE
}

model TontineCycle {
  id              Int                   @id @default(autoincrement())
  tontineId       Int
  numeroCycle     Int
  beneficiaireId  Int
  montantPot      Decimal 
  statut          StatutCycle           @default(EN_COURS)
  dateDebut       DateTime              @default(now())
  dateCloture     DateTime?

  tontine         Tontine               @relation(fields: [tontineId], references: [id])
  beneficiaire    TontineMembre         @relation("CycleBeneficiaire", fields: [beneficiaireId], references: [id])
  contributions   TontineContribution[]

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([tontineId, numeroCycle])
}

model TontineContribution {
  id              Int                   @id @default(autoincrement())
  cycleId         Int
  membreId        Int
  montant         Decimal
  statut          StatutContribution    @default(EN_ATTENTE)
  datePaiement    DateTime?
  notePaiement    String?

  cycle           TontineCycle          @relation(fields: [cycleId], references: [id])
  membre          TontineMembre         @relation(fields: [membreId], references: [id])

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([cycleId, membreId])
}

model Credit {
  id                  Int               @id @default(autoincrement())
  memberId            Int?
  montant             Decimal
  montantRestant      Decimal
  dateDemande         DateTime          @default(now())
  statut              StatutCredit      @default(EN_ATTENTE)
  scoreRisque         Decimal?

  clientId            Int?
  client              Client?           @relation(fields: [clientId], references: [id])

  member              User?             @relation(fields: [memberId], references: [id])
  transactions        CreditTransaction[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}    
  
model CreditTransaction {  
  id                  Int               @id @default(autoincrement())
  creditId            Int
  montant             Decimal
  type                TransactionCreditType
  description         String?

  credit              Credit            @relation(fields: [creditId], references: [id])

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}
 
enum StatutCredit {
  EN_ATTENTE
  APPROUVE
  REJETE
  REMBOURSE_PARTIEL
  REMBOURSE_TOTAL
}

enum TransactionCreditType {
  DECAISSEMENT
  REMBOURSEMENT
}

enum SourceCreditAlim {   
  COTISATION
  TONTINE   
}

model CreditAlimentaire {
  id                  Int               @id @default(autoincrement())
  memberId            Int?
  member              User?             @relation(fields: [memberId], references: [id])

  clientId            Int?
  client              Client?           @relation(fields: [clientId], references: [id])

  plafond             Decimal
  montantUtilise      Decimal           @default(0)
  montantRestant      Decimal // CalculÃ© automatiquement

  source              SourceCreditAlim  @default(COTISATION)
  sourceId            Int // ID de la cotisation ou de la tontine

  dateAttribution     DateTime          @default(now())
  dateExpiration      DateTime?

  statut              StatutCreditAlim  @default(ACTIF)

  transactions        CreditAlimentaireTransaction[]
  ventes              VenteCreditAlimentaire[] // âœ… AJOUTÃ‰

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model VenteCreditAlimentaire {
  id                  Int                @id @default(autoincrement())
  creditAlimentaireId Int
  produitId           Int
  quantite            Int
  prixUnitaire        Decimal

  creditAlimentaire   CreditAlimentaire  @relation(fields: [creditAlimentaireId], references: [id])
  produit             Produit            @relation(fields: [produitId], references: [id])

  createdAt           DateTime           @default(now())
}

model CreditAlimentaireTransaction {
  id                  Int                @id @default(autoincrement())
  creditId            Int
  montant             Decimal
  type                TypeCreditAlim
  description         String?

  credit              CreditAlimentaire  @relation(fields: [creditId], references: [id])

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
}

enum StatutCreditAlim {
  ACTIF
  EPUISE
  EXPIRE
}

enum TypeCreditAlim {  
  UTILISATION
  ANNULATION
  AJUSTEMENT
}
  
/**
 * ========= STOCK (facultatif mais prÃªt) ==========
 */

model Produit {
  id                  Int                  @id @default(autoincrement())
  nom                 String
  description         String?
  prixUnitaire        Decimal
  stock               Int                  @default(0)
  alerteStock         Int                  @default(0)

  mouvements          MouvementStock[]
  ventesCreditAlim    VenteCreditAlimentaire[] // âœ… AJOUTÃ‰

  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model MouvementStock {
  id                  Int                  @id @default(autoincrement())
  produitId           Int
  type                TypeMouvement
  quantite            Int
  motif               String?
  reference           String               @unique
  dateMouvement       DateTime             @default(now())

  produit             Produit              @relation(fields: [produitId], references: [id])
}

enum TypeMouvement {    
  ENTREE
  SORTIE
  AJUSTEMENT
}

model Paiement {
  id                  Int                  @id @default(autoincrement())
  factureId           Int
  walletId            Int
  montant             Decimal
  type                TypePaiement // Ex: WALLET_GENERAL, WALLET_TONTINE, WALLET_CREDIT, EXTERNE
  reference           String               @unique
  createdAt           DateTime             @default(now())

  facture             Facture              @relation(fields: [factureId], references: [id])
  wallet              Wallet               @relation(fields: [walletId], references: [id])
}

enum TypePaiement {
  WALLET_GENERAL
  WALLET_TONTINE
  WALLET_CREDIT
  EXTERNE
}

enum TypeFacture {
  COTISATION
  TONTINE
  CREDIT
  CREDIT_ALIMENTAIRE
  ACHAT
}

enum StatutFacture {
  BROUILLON
  PAYEE
  ANNULEE
}

model Facture {
  id                  Int                   @id @default(autoincrement())
  reference           String                @unique
  memberId            Int
  montant             Decimal
  type                TypeFacture
  statut              StatutFacture

  member              User                  @relation(fields: [memberId], references: [id])
  paiements           Paiement[] // âœ… AJOUTÃ‰ pour relation inverse

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
}

model AuditLog {
  id                  Int                   @id @default(autoincrement())
  userId              Int?
  action              String
  entite              String
  entiteId            Int?
  createdAt           DateTime              @default(now())

  user                User?                 @relation(fields: [userId], references: [id])
}

model Parametre {
  cle                 String                @id
  valeur              String
}    
  
model Notification {
  id                  Int                   @id @default(autoincrement())
  uuid                String                @unique @default(uuid())
  
  // Relation avec l'utilisateur
  userId              Int
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Informations de base   
  titre               String
  message             String
  priorite            PrioriteNotification  @default(NORMAL)
  
  // Ã‰tat de la notification
  lue                 Boolean               @default(false)
  dateLecture         DateTime?
  
  // Action associÃ©e
  actionUrl           String?               // URL vers la page de dÃ©tail
  
  // Dates
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  // Index pour optimiser les requÃªtes
  @@index([userId, lue])
  @@index([userId, createdAt]) 
}

enum PrioriteNotification {
  URGENT       // Rouge - Action immÃ©diate requise
  HAUTE        // Orange - Important
  NORMAL       // Gris - Standard
  BASSE        // Bleu - Info
}  